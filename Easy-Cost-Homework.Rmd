---
title: "R Notebook"
output: html_notebook
---

**Libraries**

```{r}
library(FactoMineR)
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(factoextra)
library(gridExtra)
```



**Screw Caps Data**
```{r}
raw_data <- read.table("ScrewCaps.csv",header=TRUE, sep=",", dec=".", row.names=1)
summary(raw_data)
```



**Univariate & Bivariate Descriptive Statistics**

*How is the distribution of the Price? Comment your plot with respect to the quartiles of the Price.*

As illustrated in the plots below, the distribution of the price is bimodal.

Finish fixing this 

```{r}

price_density <- ggdensity(raw_data,x="Price",y = "..count..",
                        color="darkblue",
                        fill="lightblue",size=0.5, 
                        alpha=0.2, 
                        title = "Price Distribution", 
                        linetype = "solid", add = c("median"),ylim=c(0,20),xlim=c(0,50)) +scale_x_continuous(limits=c(0,50))
  
price_boxplot <- ggboxplot(raw_data$Price, 
                           width = 0.1, 
                           fill ="lightgray", 
                           outlier.colour = "darkblue", outlier.shape=4.2, ylim=c(0,50),
                           xlim=c(0,20)) + rotate() 
price_boxplot_grob <- ggplotGrob(price_boxplot) 

price_density + annotation_custom(grob = price_boxplot_grob, xmin= 0, xmax = 50, ymin= -4.5 , ymax=6)

ggarrange(price_density, price_boxplot, ncol = 2, nrow = 1)

```




*Does the Price depend on the Length? weight?*

```{r}

ggplot(raw_data, aes(x=Length, y=Price)) + geom_point() + geom_smooth(method=lm, color="darkblue")+ theme_minimal()

ggplot(raw_data, aes(x=weight, y=Price)) + geom_point() + geom_smooth(method=lm,color="red")+theme_minimal()

```

*Does the Price depend on the Impermeability? Shape?*

The plots below suggests there is some dependence on Impermeability - the medians differ significantly 


```{r}
impermability_plot_1 <- ggdotplot(raw_data,x="Impermeability",y="Price",color = "Impermeability", palette = "jco",binwidth = 1,legend="none")

shape_plot_1 <- ggdotplot(raw_data,x="Shape",y="Price",color = "Shape", palette = "npg",binwidth = 1,legend="none")

impermability_plot_2 <- ggboxplot(raw_data,x="Impermeability",y="Price",color = "Impermeability", palette = "jco",legend="none")

shape_plot_2 <- ggboxplot(raw_data,x="Shape",y="Price",color = "Shape", palette = "npg", legend = "none")

ggarrange(ggarrange(impermability_plot_1,impermability_plot_2,ncol = 2, nrow = 1),
           ggarrange(shape_plot_1,shape_plot_2,ncol = 2, nrow = 1),
           ncol = 1, nrow = 2)

```

*Which is the less expensive Supplier?*

```{r}
#Do this questions
```


*One important point in explanatory data analysis consists in identifying potential outliers. Could you give points which are suspect regarding the Mature.Volume variable? Give the characteristics (other features) of the observations that seem suspsect* 
```{r}

Mature.Volume_plot_2 <- gghistogram(raw_data,x="Mature.Volume",y="..count..")
Mature.Volume_plot_2
```


*Perform a PCA on the dataset ScrewCap, explain briefly what are the aims of a PCA and how categorical variables are handled?*

This dataset 1 quantitative variable (Price) and 5 qualitative variables (Supplier, Shape, Impermeability and Finishing) which are considered as illustrative.

```{r}
res.pca <- PCA(raw_data,quali.sup = c(1,5,6,7,9),quanti.sup = 10)

fviz_pca_ind(res.pca, col.ind="contrib") + scale_color_gradient2(low="blue", mid="white", high="red", midpoint=4) + theme_minimal()

```

*Compute the correlation matrix between the variables and comment it with respect to the correlation circle*

We first center and standardize the variables:

```{r}
#virer les outliers

don <- as.matrix(raw_data[,-c(1,5,6,7,9,10)]) %>% scale()
don_correlation <- cor(don)
```


6) On what kind of relationship PCA focuses? Is it a problem?

7) Comment the PCA outputs.
• Comment the position of the categories Impermeability=type 2 and Raw.Material=PS.
• Comment the percentage of inertia
```{r}
barplot(res.pca$eig[,2], names.arg = 1:nrow(res.pca$eig))
drawn <- c("90", "89", "164", "161", "163", "131")
plot.PCA(res.pca, select = drawn, axes = 1:2, choix = 'ind', invisible = 'quali', title = '')
wilks.p <- structure(c(1.39936324848005e-27, 1.02072912984402e-22, 2.01088132732067e-11, 
3.37174568997818e-07, 0.394546176405119), .Names = c("Impermeability", "Raw.Material", "Shape", "Supplier", "Finishing"))
wilks.p

sample = sample(rownames(res.pca$call$X), length(rownames(res.pca$call$X)))
res.pca$call$X = res.pca$call$X[sample,]
res.pca$ind$coord = res.pca$ind$coord[sample[!sample %in% rownames(res.pca$ind.sup$coord)],]
res.pca$ind.sup$coord = res.pca$ind.sup$coord[sample[sample %in% rownames(res.pca$ind.sup$coord)],]

drawn <-c("90", "89", "164", "161", "163", "131")
hab <-"Impermeability"
plotellipses(res.pca, axes = 1:2, invisible = 'quali', select = drawn, keepvar = hab, title = '')

drawn <-c("Length", "Diameter", "weight", "nb.of.pieces", "Price")
plot.PCA(res.pca, select = drawn, axes = 1:2, choix = 'var', title = '')

drawn <- c("Type 1", "Type 2", "Supplier A", "PS", "PP", "Shape 2", "Shape 3", "Shape 1", "Lacquering", "Supplier B", "Supplier C","Hot Printing")
plot.PCA(res.pca, select = drawn, axes = 1:2, choix = 'ind', invisible = c('ind', 'ind.sup'), title = '')






res.pca <- PCA(raw_data,quali.sup = c(1,5,6,7,9),quanti.sup = 10, ncp=3) #ncp = 3
res.hcpc = HCPC(res.pca, nb.clust = -1
                , graph = FALSE)

drawn <- c("90", "89", "164", "161", "163", "131")
plot.HCPC(res.hcpc, choice = 'map', draw.tree = FALSE, select = drawn, title = '')
dimdesc(res.pca, axes = 1:1)
res.hcpc$desc.var

```

```{r}

fviz_nbclust(don, kmeans, method = "wss") + geom_vline(xintercept = 3, linetype = 2)



```


*Comments the results and describe precisely one cluster*

The cluster 1 is made of individuals sharing :
- high values for the variable Mature.Volume. 
- low values for the variables nb.of.pieces, Price, weight, Length and Diameter (variables are sorted from the weakest).

The cluster 2 is made of individuals sharing :
- high values for the variable nb.of.pieces. 
- low values for the variables Mature.Volume, Diameter, Length, weight and Price (variables are sorted from the weakest).

The cluster 3 is made of individuals such as 89, 90, 131, 161, 163 and 164. This group is characterized by :
- high values for the variables Length, Diameter, weight and Price (variables are sorted from the strongest).
- low values for the variables nb.of.pieces and Mature.Volume (variables are sorted from the weakest).



